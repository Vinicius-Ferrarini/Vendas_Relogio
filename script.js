const SHEET_ID="1gU34_gLsxTHDy_nxhtg91-Ld6VaU4Zba65dBkZD-2aQ",GID=0,WHATSAPP_NUMBER="5543999705837";let mainElement,navElement,listaOfertasEl,secaoOfertasEl,filtroPesquisa,filtroCategoria,filtroGenero,filtroTipoContainer,precoMin,precoMax,btnLimparFiltros,btnSortAsc,btnSortDesc,activeTimers={},allProducts=new Map,dynamicCategories=new Map,currentSortOrder="default";function escapeHtml(e){return e||0===e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function vazioElemento(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function formatPrice(e){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(e||0)}function removerAcentos(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function getCart(){return JSON.parse(localStorage.getItem("leandrinhoCart")||"[]")}function saveCart(e){localStorage.setItem("leandrinhoCart",JSON.stringify(e))}function updateCartButtonText(){const e=document.getElementById("enviarWhatsApp");if(!e)return;const t=getCart().reduce(((e,t)=>e+t.quantity),0);e.textContent=t>0?`ðŸŸ¢ Ver Carrinho (${t} ${t>1?"itens":"item"})`:"ðŸŸ¢ Carrinho Vazio"}function abrirModalCarrinho(){const e=getCart(),t=document.getElementById("modalCarrinho"),a=document.getElementById("listaCarrinhoModal"),r=document.getElementById("totalCarrinhoModal"),o=document.getElementById("enviarPedidoModal");if(vazioElemento(a),0===e.length)a.innerHTML="<p>Seu carrinho estÃ¡ vazio.</p>",r.textContent="Total: R$ 0,00",o.style.display="none",document.getElementById("observacaoPedido").value="";else{let t=0;e.forEach((e=>{const r=document.createElement("div");r.className="cart-item-modal",r.innerHTML=`<div class="cart-item-modal-info"><span class="nome">${escapeHtml(e.nome)}</span><span class="preco">${formatPrice(e.preco)}</span></div><div class="cart-item-modal-controls"><button class="qty-btn decrease-qty" data-id="${escapeHtml(e.id)}" ${e.quantity<=1?"disabled":""}>-</button><span>${e.quantity}</span><button class="qty-btn increase-qty" data-id="${escapeHtml(e.id)}">+</button></div><button class="remover-item-btn" data-id="${escapeHtml(e.id)}">Remover</button>`,a.appendChild(r),t+=e.preco*e.quantity})),r.textContent=`Total: ${formatPrice(t)}`,o.style.display="block"}t.style.display="flex"}function fecharModalCarrinho(){document.getElementById("modalCarrinho").style.display="none"}function handleRemoverItem(e){let t=getCart();t=t.filter((t=>t.id.toString()!==e.toString())),saveCart(t),abrirModalCarrinho(),updateCartButtonText();document.querySelectorAll(`.btn-add-cart[data-id="${e}"]`).forEach((e=>{e&&(e.textContent="Adicionar ao Carrinho",e.disabled=!1)}))}function increaseQuantity(e){let t=getCart();const a=t.findIndex((t=>t.id.toString()===e.toString()));a>-1&&(t[a].quantity++,saveCart(t),abrirModalCarrinho(),updateCartButtonText())}function decreaseQuantity(e){let t=getCart();const a=t.findIndex((t=>t.id.toString()===e.toString()));a>-1&&t[a].quantity>1?(t[a].quantity--,saveCart(t),abrirModalCarrinho(),updateCartButtonText()):a>-1&&1===t[a].quantity&&handleRemoverItem(e)}function handleEnviarPedido(){const e=getCart(),t=document.getElementById("observacaoPedido").value.trim(),a=document.getElementById("enviarPedidoModal");if(0===e.length)return void alert("Seu carrinho estÃ¡ vazio.");a.disabled=!0,a.textContent="Abrindo WhatsApp...";const r=e.map((e=>{const t=formatPrice(e.preco*e.quantity);return`${e.quantity}x ${e.nome} (${formatPrice(e.preco)} cada) - ${t}`})),o=formatPrice(e.reduce(((e,t)=>e+t.preco*t.quantity),0));let n=`OlÃ¡! Gostaria de fazer o seguinte pedido:\n\n${r.join("\n")}`;n+=`\n\n*Subtotal: ${o}*`,t&&(n+=`\n\n*ObservaÃ§Ãµes:* ${t}`);const i=`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(n)}`;window.open(i,"_blank"),setTimeout((()=>{console.log("Limpando carrinho apÃ³s envio..."),saveCart([]),document.getElementById("observacaoPedido").value="",updateCartButtonText(),document.querySelectorAll(".btn-add-cart:disabled").forEach((e=>{"enviarPedidoModal"!==e.id&&(e.textContent="Adicionar ao Carrinho",e.disabled=!1)})),fecharModalCarrinho()}),500)}async function fetchSheetJson(e,t=0){const a=`https://docs.google.com/spreadsheets/d/${e}/gviz/tq?tqx=out:json&gid=${t}`,r=await fetch(a),o=await r.text(),n=o.indexOf("("),i=o.lastIndexOf(")"),c=o.substring(n+1,i);return JSON.parse(c)}function mapRowToProduct(e,t){const a={images:[],ativo:!0};return t.forEach(((t,r)=>{const o=e[r],n=o&&void 0!==o.v?o.v:"",i=(t||"").toString().trim().toLowerCase();if(i.match(/^id$/))a.id=n;else if(i.match(/nome|name|produto/))a.nome=n;else if(i.match(/pre[cÃ§]o[ \-]?oferta/))if("number"==typeof n)a.precoOferta=n;else{const e=String(n).replace(/[R$\s.]/g,"").replace(",","."),t=parseFloat(e);!isNaN(t)&&t>0&&(a.precoOferta=t)}else if(i.match(/pre[cÃ§]o|price|valor/))if("number"==typeof n)a.preco=n;else{const e=String(n).replace(/[R$\s.]/g,"").replace(",","."),t=parseFloat(e);a.preco=isNaN(t)?0:t}else i.match(/categoria|category/)?a.categoria=n.toString().toLowerCase():i.match(/tipo|type/)?a.tipo=n.toString().toLowerCase():i.match(/genero|gÃªnero|genÃªro|sex|sexo/)?a.genero=n.toString().toLowerCase():i.match(/destaque/)?a.destaque=n:i.match(/descricao|descri[cÃ§][aÃ£]o/)?a.descricao=n:i.match(/dataoferta/)?o&&o.f?a.dataOferta=o.f:n&&n.toString().includes("/")?a.dataOferta=n.toString():a.dataOferta="":i.match(/horaoferta/)?a.horaOferta=n:i.match(/^img\d?$|^imagem\d?$|^foto\d?$/)?n&&a.images.push(n.toString()):i.match(/^ativo$/)&&(a.ativo=!("N"===String(n).trim().toUpperCase()))})),a.nome=a.nome||"",a.preco=void 0!==a.preco?a.preco:0,a.categoria=a.categoria||"outros",a.tipo=a.tipo||"",a.genero=a.genero||"",a.id=(a.id||`${Date.now()}-${Math.random()}`).toString(),a.oferta=a.destaque&&""!==a.destaque||a.dataOferta&&""!==a.dataOferta,0===a.images.length&&a.images.push("https://via.placeholder.com/800x800?text=Sem+Imagem"),void 0!==a.precoOferta&&a.precoOferta<a.preco&&(a.precoOriginal=a.preco,a.preco=a.precoOferta,a.oferta=!0),a}function parseGvizResponse(e){const t=e.table.cols.map((e=>e.label||e.id||"")),a=(e.table.rows||[]).map((e=>mapRowToProduct(e.c,t))).filter((e=>e.ativo));return allProducts.clear(),dynamicCategories.clear(),a.forEach((e=>{allProducts.set(e.id,e),dynamicCategories.has(e.categoria)||dynamicCategories.set(e.categoria,{tipos:new Set,generos:new Set,containerId:`lista-${e.categoria}`,sectionId:`secao-${e.categoria}`,sectionEl:null,containerEl:null});const t=dynamicCategories.get(e.categoria);e.tipo&&t.tipos.add(e.tipo),e.genero&&t.generos.add(e.genero)})),a}function popularDropdown(e,t,a){e.innerHTML=`<option value="">${a}</option>`,Array.from(t).sort().forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=t.charAt(0).toUpperCase()+t.slice(1),e.appendChild(a)}))}function criarCheckboxesTipo(e,t){vazioElemento(e);const a=document.createElement("span");a.className="checkboxes-title",a.textContent="Tipos:",e.appendChild(a),Array.from(t).sort().forEach((t=>{const a=document.createElement("label"),r=document.createElement("input");r.type="checkbox",r.value=t,r.addEventListener("change",filtrarEExibirProdutos),a.appendChild(r),a.appendChild(document.createTextNode(` ${t.charAt(0).toUpperCase()+t.slice(1)}`)),e.appendChild(a)}))}function criarSecoesCategorias(){vazioElemento(navElement),Array.from(mainElement.querySelectorAll(".secao-categoria")).forEach((e=>e.remove()));const e=document.createElement("a");e.href="#secao-ofertas",e.textContent="Ofertas",navElement.appendChild(e);const t=Array.from(dynamicCategories.keys()).sort();for(const e of t){const t=dynamicCategories.get(e),a=document.createElement("div");a.id=t.sectionId,a.className="secao-categoria";const r=document.createElement("h2");r.className="titulo-secao",r.textContent=e.charAt(0).toUpperCase()+e.slice(1);const o=document.createElement("div");o.className="container",o.id=t.containerId,o.innerHTML=`<div class="loading-message">Carregando ${e}...</div>`,a.appendChild(r),a.appendChild(o),mainElement.appendChild(a),t.sectionEl=a,t.containerEl=o;const n=document.createElement("a");n.href=`#${t.sectionId}`,n.textContent=e.charAt(0).toUpperCase()+e.slice(1),navElement.appendChild(n)}}function criarCardHTML(e){const t=e.images&&e.images.length?e.images:["https://via.placeholder.com/800x800?text=Sem+Imagem"],a=t[0],r=t.slice(0,4).map((e=>`<img src="${escapeHtml(e)}" alt="Miniatura" class="card-thumb" loading="lazy">`)).join(""),o=formatPrice(e.preco),n=e.precoOriginal?`<span class="preco-original">${formatPrice(e.precoOriginal)}</span>`:"",i=`detalhe.html?data=${encodeURIComponent(JSON.stringify(e))}`,c=e.destaque?`<div class="card-badge">${escapeHtml(e.destaque)}</div>`:"",s=e.dataOferta?`<div class="card-timer" id="timer-${e.id}"></div>`:"",l=getCart().find((t=>t.id.toString()===e.id.toString())),d=l?"âœ… JÃ¡ no carrinho":"Adicionar ao Carrinho",m=l?"disabled":"",u=document.createElement("div");return u.className="card",u.innerHTML=`${c}${s}<div class="card-img-main"><a href="${i}"><img src="${escapeHtml(a)}" alt="${escapeHtml(e.nome)}" loading="lazy" class="card-img-main-pic"></a></div><div class="card-img-thumbs">${r}</div><h3>${escapeHtml(e.nome)}</h3><p class="preco-container">${n}<span class="preco-atual">${o}</span></p><button class="btn-add-cart" data-id="${escapeHtml(e.id)}" ${m}>${d}</button>`,u}function mostrarMensagemNoContainer(e,t){if(!e)return;vazioElemento(e);const a=document.createElement("div");a.className="loading-message",a.textContent=t,e.appendChild(a)}function clearTimers(e){activeTimers[e]&&activeTimers[e].forEach((e=>clearInterval(e))),activeTimers[e]=[]}function iniciarContadores(e,t){clearTimers(t),e.forEach((e=>{if(!e.dataOferta)return;const a=document.getElementById(`timer-${e.id}`);if(!a)return;const[r,o,n]=e.dataOferta.split("/");if(!r||!o||!n)return void console.warn(`Data de oferta invÃ¡lida para ${e.nome}: ${e.dataOferta}`);const i=e.horaOferta?parseInt(e.horaOferta,10):23,c=e.horaOferta?0:59,s=e.horaOferta?0:59;let l=parseInt(n,10);2===n.length&&(l+=2e3);const d=new Date(l,o-1,r,i,c,s),m=setInterval((()=>{const e=(new Date).getTime(),t=d.getTime()-e;if(t<=0)return clearInterval(m),void(a.style.display="none");const r=Math.floor(t/864e5),o=Math.floor(t%864e5/36e5),n=Math.floor(t%36e5/6e4),i=Math.floor(t%6e4/1e3);a.innerHTML=`${r}d ${o}h ${n}m ${i}s`}),1e3);activeTimers[t]||(activeTimers[t]=[]),activeTimers[t].push(m)}))}function criarCardsEAdicionar(e,t){e&&(vazioElemento(e),t&&0!==t.length?(t.forEach((t=>{const a=criarCardHTML(t);e.appendChild(a)})),iniciarContadores(t,e.id)):mostrarMensagemNoContainer(e,"Nenhum produto encontrado."))}function filtrarLista(e,{categoria:t="",genero:a="",tipos:r=[],precoMin:o=0,precoMax:n=1/0,searchTerm:i=""}={}){const c=removerAcentos(i.toLowerCase());return e.filter((e=>{if(t&&e.categoria!==t)return!1;if(a&&String(e.genero||"").toLowerCase()!==String(a||"").toLowerCase())return!1;if(r.length>0&&!r.includes(String(e.tipo||"").toLowerCase()))return!1;const i=Number(e.preco||0);if(!isNaN(o)&&i<o)return!1;if(!isNaN(n)&&i>n)return!1;if(c){if(!removerAcentos(e.nome.toLowerCase()).includes(c))return!1}return!0}))}function adicionarClickHandlerMiniaturas(e){if(e.target.classList.contains("card-thumb")){e.preventDefault();const t=e.target.closest(".card");if(t){const a=t.querySelector(".card-img-main-pic");a&&(a.src=e.target.src)}}}function handleAddToCartClick(e){if(!e.target.classList.contains("btn-add-cart"))return;const t=e.target.dataset.id,a=allProducts.get(t);if(!a)return;let r=getCart();const o=r.findIndex((e=>e.id===a.id));o>-1?r[o].quantity++:r.push({id:a.id,nome:a.nome,preco:a.preco,quantity:1}),saveCart(r),updateCartButtonText();document.querySelectorAll(`.btn-add-cart[data-id="${t}"]`).forEach((e=>{e&&(e.textContent="âœ… JÃ¡ no carrinho",e.disabled=!0)}))}function filtrarEExibirProdutos(){console.log("Filtrando...");const e=filtroCategoria.value,t=filtroGenero.value,a=precoMin.value?Number(precoMin.value):0,r=precoMax.value?Number(precoMax.value):1/0,o=filtroPesquisa.value.trim(),n=[];filtroTipoContainer.querySelectorAll('input[type="checkbox"]:checked').forEach((e=>n.push(e.value)));const i={categoria:e,genero:t,tipos:n,precoMin:a,precoMax:r,searchTerm:o},c=filtrarLista(Array.from(allProducts.values()),i);let s=!1;const l=c.filter((e=>e.oferta));l.length>0?(s=!0,secaoOfertasEl&&(secaoOfertasEl.style.display="block"),"priceAsc"===currentSortOrder?l.sort(((e,t)=>e.preco-t.preco)):"priceDesc"===currentSortOrder&&l.sort(((e,t)=>t.preco-e.preco)),criarCardsEAdicionar(listaOfertasEl,l)):secaoOfertasEl&&(secaoOfertasEl.style.display="none");for(const[e,t]of dynamicCategories.entries()){const a=c.filter((t=>t.categoria===e));(!i.categoria||e===i.categoria)&&a.length>0?(t.sectionEl&&(t.sectionEl.style.display="block"),t.containerEl&&("priceAsc"===currentSortOrder?a.sort(((e,t)=>e.preco-t.preco)):"priceDesc"===currentSortOrder&&a.sort(((e,t)=>t.preco-e.preco)),criarCardsEAdicionar(t.containerEl,a))):t.sectionEl&&(t.sectionEl.style.display="none")}document.getElementById("sortAsc").classList.toggle("active","priceAsc"===currentSortOrder),document.getElementById("sortDesc").classList.toggle("active","priceDesc"===currentSortOrder)}async function loadAndRender(){mostrarMensagemNoContainer(listaOfertasEl,"Carregando produtos..."),vazioElemento(navElement),Array.from(mainElement.querySelectorAll(".secao-categoria")).forEach((e=>e.remove()));let e=[];try{e=parseGvizResponse(await fetchSheetJson(SHEET_ID,0)),console.log("Dados carregados (gviz):",e.length,"produtos ativos")}catch(t){console.warn("Falha ao carregar via gviz, tentando fallback opensheet:",t);try{const t=`https://opensheet.elk.sh/${SHEET_ID}/PÃ¡gina1`,a=await fetch(t);if(!a.ok)throw new Error(`OpenSheet falhou com status ${a.status}`);const r=await a.json();e=r.map((e=>{const t=Object.keys(e);return mapRowToProduct(t.map((t=>({v:e[t]}))),t)})).filter((e=>e.ativo)),allProducts.clear(),dynamicCategories.clear(),e.forEach((e=>{allProducts.set(e.id,e),dynamicCategories.has(e.categoria)||dynamicCategories.set(e.categoria,{tipos:new Set,generos:new Set,containerId:`lista-${e.categoria}`,sectionId:`secao-${e.categoria}`,sectionEl:null,containerEl:null});const t=dynamicCategories.get(e.categoria);e.tipo&&t.tipos.add(e.tipo),e.genero&&t.generos.add(e.genero)})),console.log("Dados carregados (opensheet):",e.length,"produtos ativos")}catch(e){console.error("Erro ao carregar planilha pelo fallback:",e),mostrarMensagemNoContainer(listaOfertasEl,"Erro ao carregar produtos. Verifique o console.");for(const e of dynamicCategories.values())e.containerEl&&mostrarMensagemNoContainer(e.containerEl,"Erro ao carregar produtos.");return}}criarSecoesCategorias(),popularDropdown(filtroCategoria,dynamicCategories.keys(),"Todas as Categorias"),filtrarEExibirProdutos(),updateCartButtonText(),filtroPesquisa.addEventListener("input",filtrarEExibirProdutos),filtroCategoria.addEventListener("change",(e=>{const t=e.target.value;if(filtroGenero.value="",filtroGenero.style.display="none",vazioElemento(filtroTipoContainer),filtroTipoContainer.style.display="none",t){const e=dynamicCategories.get(t);e&&(e.generos.size>0&&(popularDropdown(filtroGenero,e.generos,"Todos os GÃªneros"),filtroGenero.style.display="block"),e.tipos.size>0&&(criarCheckboxesTipo(filtroTipoContainer,e.tipos),filtroTipoContainer.style.display="flex"))}filtrarEExibirProdutos()})),filtroGenero.addEventListener("change",filtrarEExibirProdutos),precoMin.addEventListener("input",filtrarEExibirProdutos),precoMax.addEventListener("input",filtrarEExibirProdutos),btnSortAsc.addEventListener("click",(()=>{currentSortOrder="priceAsc",filtrarEExibirProdutos()})),btnSortDesc.addEventListener("click",(()=>{currentSortOrder="priceDesc",filtrarEExibirProdutos()})),btnLimparFiltros.addEventListener("click",(()=>{filtroPesquisa.value="",filtroCategoria.value="",filtroGenero.value="",vazioElemento(filtroTipoContainer),precoMin.value="",precoMax.value="",filtroGenero.style.display="none",filtroTipoContainer.style.display="none",currentSortOrder="default",filtrarEExibirProdutos()})),mainElement.addEventListener("click",(e=>{adicionarClickHandlerMiniaturas(e),handleAddToCartClick(e)}));document.getElementById("enviarWhatsApp").addEventListener("click",(()=>{0!==getCart().length?abrirModalCarrinho():alert("Seu carrinho estÃ¡ vazio.")})),document.getElementById("fecharModal").addEventListener("click",fecharModalCarrinho),document.getElementById("modalCarrinho").addEventListener("click",(e=>{e.target.classList.contains("modal-overlay")&&fecharModalCarrinho()})),document.getElementById("listaCarrinhoModal").addEventListener("click",(e=>{const t=e.target,a=t.dataset.id;a&&(t.classList.contains("remover-item-btn")?handleRemoverItem(a):t.classList.contains("increase-qty")?increaseQuantity(a):t.classList.contains("decrease-qty")&&decreaseQuantity(a))})),document.getElementById("enviarPedidoModal").addEventListener("click",handleEnviarPedido)}document.addEventListener("DOMContentLoaded",(()=>{mainElement=document.querySelector("main"),navElement=document.getElementById("menuNavegacao"),listaOfertasEl=document.getElementById("listaOfertas"),secaoOfertasEl=document.getElementById("secao-ofertas"),filtroPesquisa=document.getElementById("filtroPesquisa"),filtroCategoria=document.getElementById("filtroCategoria"),filtroGenero=document.getElementById("filtroGenero"),filtroTipoContainer=document.getElementById("filtroTipoContainer"),precoMin=document.getElementById("precoMin"),precoMax=document.getElementById("precoMax"),btnLimparFiltros=document.getElementById("limparFiltros"),btnSortAsc=document.getElementById("sortAsc"),btnSortDesc=document.getElementById("sortDesc"),loadAndRender().catch((e=>{console.error("Erro na inicializaÃ§Ã£o:",e),mostrarMensagemNoContainer(listaOfertasEl,"Erro grave na inicializaÃ§Ã£o. Verifique o console."),Array.from(mainElement.querySelectorAll(".secao-categoria .container")).forEach((e=>{mostrarMensagemNoContainer(e,"Erro ao carregar produtos.")}))}))}));