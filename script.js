function removerAcentos(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function slugify(e){return e?removerAcentos(e.toLowerCase().trim()).replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-"):`produto-sem-nome-${Date.now()}`}function showSkeletonLoaders(e,t=5){if(!e)return;vazioElemento(e);const r='\n        <div class="skeleton-card">\n            <div class="skeleton-img"></div>\n            <div class="skeleton-title"></div>\n            <div class="skeleton-price"></div>\n            <div class="skeleton-button"></div>\n        </div>\n    ';for(let o=0;o<t;o++)e.innerHTML+=r}async function fetchSheetJson(e,t=0){const r=`https://docs.google.com/spreadsheets/d/${e}/gviz/tq?tqx=out:json&gid=${t}`,o=await fetch(r),a=await o.text(),n=a.indexOf("("),i=a.lastIndexOf(")"),c=a.substring(n+1,i);return JSON.parse(c)}function mapRowToProduct(e,t){const r={images:[],ativo:!0};if(t.forEach((t,o)=>{const a=e[o],n=a&&void 0!==a.v?a.v:"",i=(t||"").toString().trim().toLowerCase();if(i.match(/^id$/))r.id=n;else if(i.match(/nome|name|produto/))r.nome=n;else if(i.match(/pre[cç]o[ \-]?oferta/))if("number"==typeof n)r.precoOferta=n;else{const e=String(n).replace(/[R$\s.]/g,"").replace(",","."),t=parseFloat(e);!isNaN(t)&&t>0&&(r.precoOferta=t)}else if(i.match(/pre[cç]o|price|valor/))if("number"==typeof n)r.preco=n;else{const e=String(n).replace(/[R$\s.]/g,"").replace(",","."),t=parseFloat(e);r.preco=isNaN(t)?0:t}else i.match(/categoria|category/)?r.categoria=n.toString().toLowerCase():i.match(/tipo|type/)?r.tipo=n.toString().toLowerCase():i.match(/genero|gênero|genêro|sex|sexo/)?r.genero=n.toString().toLowerCase():i.match(/destaque/)?r.destaque=n:i.match(/descricao|descri[cç][aã]o/)?r.descricao=n:i.match(/dataoferta/)?a&&a.f?r.dataOferta=a.f:n&&n.toString().includes("/")?r.dataOferta=n.toString():r.dataOferta="":i.match(/horaoferta/)?r.horaOferta=n:i.match(/^img\d?$|^imagem\d?$|^foto\d?$/)?n&&r.images.push(n.toString()):i.match(/^ativo$/)&&(r.ativo=!("N"===String(n).trim().toUpperCase()))}),r.nome=r.nome||"",r.preco=void 0!==r.preco?r.preco:0,r.categoria=r.categoria||"outros",r.tipo=r.tipo||"",r.genero=r.genero||"",r.id?r.id=r.id.toString():r.id=slugify(r.nome),r.oferta=r.destaque&&""!==r.destaque||r.dataOferta&&""!==r.dataOferta,0===r.images.length&&r.images.push("https://via.placeholder.com/800x800?text=Sem+Imagem"),r.precoOriginal=r.preco,void 0!==r.precoOferta&&r.precoOferta<r.preco){let e=!1;if(r.dataOferta){const[t,o,a]=r.dataOferta.split("/");if(t&&o&&a){const n=r.horaOferta?parseInt(r.horaOferta,10):23,i=r.horaOferta?0:59,c=r.horaOferta?0:59;let s=parseInt(a,10);2===a.length&&(s+=2e3);const l=new Date(s,o-1,t,n,i,c);l.getTime()<Date.now()&&(e=!0)}}e?r.oferta=!1:(r.precoOriginal=r.preco,r.preco=r.precoOferta,r.oferta=!0)}else r.precoOriginal=r.preco;return r}function parseGvizResponse(e){const t=e.table.cols.map(e=>e.label||e.id||""),r=e.table.rows||[],o=r.map(e=>mapRowToProduct(e.c,t)).filter(e=>e.ativo);return allProducts.clear(),dynamicCategories.clear(),o.forEach(e=>{allProducts.set(e.id,e),dynamicCategories.has(e.categoria)||dynamicCategories.set(e.categoria,{tipos:new Set,generos:new Set,containerId:`lista-${e.categoria}`,sectionId:`secao-${e.categoria}`,sectionEl:null,containerEl:null});const t=dynamicCategories.get(e.categoria);e.tipo&&t.tipos.add(e.tipo),e.genero&&t.generos.add(e.genero)}),o}function popularDropdown(e,t,r){e.innerHTML=`<option value="">${r}</option>`,Array.from(t).sort().forEach(t=>{const r=document.createElement("option");r.value=t,r.textContent=t.charAt(0).toUpperCase()+t.slice(1),e.appendChild(r)})}function criarCheckboxesTipo(e,t){vazioElemento(e);const r=document.createElement("span");r.className="checkboxes-title",r.textContent="Tipos:",e.appendChild(r),Array.from(t).sort().forEach(t=>{const r=document.createElement("label"),o=document.createElement("input");o.type="checkbox",o.value=t,o.addEventListener("change",filtrarEExibirProdutos),r.appendChild(o),r.appendChild(document.createTextNode(` ${t.charAt(0).toUpperCase()+t.slice(1)}`)),e.appendChild(r)})}function criarSecoesCategorias(){vazioElemento(navElement),Array.from(mainElement.querySelectorAll(".secao-categoria")).forEach(e=>e.remove());const e=document.createElement("a");e.href="#secao-ofertas",e.textContent="Ofertas",navElement.appendChild(e);const t=Array.from(dynamicCategories.keys()).sort();for(const e of t){const t=dynamicCategories.get(e),r=document.createElement("div");r.id=t.sectionId,r.className="secao-categoria";const o=document.createElement("h2");o.className="titulo-secao",o.textContent=e.charAt(0).toUpperCase()+e.slice(1);const a=document.createElement("div");a.className="container",a.id=t.containerId,showSkeletonLoaders(a,5),r.appendChild(o),r.appendChild(a),mainElement.appendChild(r),t.sectionEl=r,t.containerEl=a;const n=document.createElement("a");n.href=`#${t.sectionId}`,n.textContent=e.charAt(0).toUpperCase()+e.slice(1),navElement.appendChild(n)}}function criarCardHTML(e){const t="https://via.placeholder.com/800x800?text=Sem+Imagem",r=e.images&&e.images.length?e.images:[t],o=r[0],a=r.slice(0,4),n=a.map(e=>`<img src="${escapeHtml(e)}" alt="Miniatura" class="card-thumb" loading="lazy">`).join(""),i=formatPrice(e.preco),c=e.precoOriginal&&e.precoOriginal!==e.preco&&e.oferta?`<span class="preco-original">${formatPrice(e.precoOriginal)}</span>`:"",s=`detalhe.html?data=${encodeURIComponent(JSON.stringify(e))}`,l=e.oferta&&e.destaque?`<div class="card-badge">${escapeHtml(e.destaque)}</div>`:"",d=e.oferta&&e.dataOferta?`<div class="card-timer" id="timer-${e.id}"></div>`:"",p=getCart(),m=p.find(t=>t.id.toString()===e.id.toString()),f=m?"✅ Já no carrinho":"Adicionar ao Carrinho",u=m?"disabled":"",g=document.createElement("div");return g.className="card",g.innerHTML=`${l}${d}<div class="card-img-main"><a href="${s}"><img src="${escapeHtml(o)}" alt="${escapeHtml(e.nome)}" loading="lazy" class="card-img-main-pic"></a></div><div class="card-img-thumbs">${n}</div><h3>${escapeHtml(e.nome)}</h3><p class="preco-container">${c}<span class="preco-atual">${i}</span></p><button class="btn-add-cart" data-id="${escapeHtml(e.id)}" ${u}>${f}</button>`,g}function mostrarMensagemNoContainer(e,t){if(!e)return;vazioElemento(e);const r=document.createElement("div");r.className="loading-message",r.textContent=t,e.appendChild(r)}function clearTimers(e){activeTimers[e]&&activeTimers[e].forEach(e=>clearInterval(e)),activeTimers[e]=[]}function iniciarContadores(e,t){clearTimers(t),e.forEach(e=>{if(!e.dataOferta||!e.oferta)return;const r=document.getElementById(`timer-${e.id}`);if(!r)return;const[o,a,n]=e.dataOferta.split("/");if(!o||!a||!n)return void console.warn(`Data de oferta inválida para ${e.nome}: ${e.dataOferta}`);const i=e.horaOferta?parseInt(e.horaOferta,10):23,c=e.horaOferta?0:59,s=e.horaOferta?0:59;let l=parseInt(n,10);2===n.length&&(l+=2e3);const d=new Date(l,a-1,o,i,c,s),p=e=>{const t=document.querySelectorAll(`.card .btn-add-cart[data-id="${e.id}"]`);t.forEach(t=>{const r=t.closest(".card");if(r){const t=r.querySelector(".preco-atual"),o=r.querySelector(".preco-original"),a=r.querySelector(".card-timer"),n=r.querySelector(".card-badge");t&&(t.textContent=formatPrice(e.preco)),o&&(o.style.display="none"),a&&(a.style.display="none"),n&&(n.style.display="none")}})},m=()=>{const t=Date.now(),o=d.getTime()-t;if(o<=0){clearInterval(f);const t=allProducts.get(e.id);if(t&&t.precoOriginal&&t.preco!==t.precoOriginal)console.log(`Oferta expirada para ${t.nome}. Revertendo preço.`),t.preco=t.precoOriginal,t.oferta=!1,p(t);else if(r){r.style.display="none";const e=r.closest(".card");if(e){const t=e.querySelector(".card-badge");t&&(t.style.display="none")}}return}const a=Math.floor(o/864e5),n=Math.floor(o%864e5/36e5),i=Math.floor(o%36e5/6e4),c=Math.floor(o%6e4/1e3);r&&(r.innerHTML=`${a}d ${n}h ${i}m ${c}s`)},f=setInterval(m,1e3);activeTimers[t]||(activeTimers[t]=[]),activeTimers[t].push(f),m()})}function criarCardsEAdicionar(e,t){e&&(vazioElemento(e),t&&0!==t.length?(t.forEach(t=>{const r=criarCardHTML(t);e.appendChild(r)}),iniciarContadores(t,e.id)):mostrarMensagemNoContainer(e,"Nenhum produto encontrado."))}function filtrarLista(e,{categoria:t="",genero:r="",tipos:o=[],precoMin:a=0,precoMax:n=1/0,searchTerm:i=""}={}){const c=removerAcentos(i.toLowerCase());return e.filter(e=>{if(t&&e.categoria!==t)return!1;if(r&&String(e.genero||"").toLowerCase()!==String(r||"").toLowerCase())return!1;if(o.length>0&&!o.includes(String(e.tipo||"").toLowerCase()))return!1;const i=Number(e.preco||0);if(!isNaN(a)&&i<a)return!1;if(!isNaN(n)&&i>n)return!1;if(c){const t=removerAcentos(e.nome.toLowerCase());if(!t.includes(c))return!1}return!0})}function adicionarClickHandlerMiniaturas(e){if(e.target.classList.contains("card-thumb")){e.preventDefault();const t=e.target.closest(".card");if(t){const r=t.querySelector(".card-img-main-pic");r&&(r.src=e.target.src)}}}function handleAddToCartClick(e){if(!e.target.classList.contains("btn-add-cart"))return;const t=e.target,r=t.dataset.id,o=allProducts.get(r);if(!o)return;let a=getCart();const n=a.findIndex(e=>e.id===o.id&&!e.observacao);n>-1?a[n].quantity++:a.push({id:o.id,nome:o.nome,preco:o.preco,quantity:1,observacao:""}),saveCart(a),updateCartButtonText();const i=document.querySelectorAll(`.btn-add-cart[data-id="${r}"]`);i.forEach(e=>{e&&(e.id&&"detalheAddCart"===e.id||(e.textContent="✅ Já no carrinho",e.disabled=!0))})}function handleCardClick(e){const t=["btn-add-cart","card-thumb"];if(t.some(t=>e.target.classList.contains(t))||e.target.closest("a"))return;const r=e.target.closest(".card");if(r){const e=r.querySelector(".card-img-main a");e&&(window.location.href=e.href)}}function filtrarEExibirProdutos(){console.log("Filtrando...");const e=filtroCategoria.value,t=filtroGenero.value,r=precoMin.value?Number(precoMin.value):0,o=precoMax.value?Number(precoMax.value):1/0,a=filtroPesquisa.value.trim(),n=[],i=filtroTipoContainer.querySelectorAll('input[type="checkbox"]:checked');i.forEach(e=>n.push(e.value));const c={categoria:e,genero:t,tipos:n,precoMin:r,precoMax:o,searchTerm:a},s=Array.from(allProducts.values()),l=filtrarLista(s,c);let d=!1;const p=l.filter(e=>e.oferta);p.length>0?(d=!0,secaoOfertasEl&&(secaoOfertasEl.style.display="block"),"priceAsc"===currentSortOrder?p.sort((e,t)=>e.preco-t.preco):"priceDesc"===currentSortOrder&&p.sort((e,t)=>t.preco-e.preco),criarCardsEAdicionar(listaOfertasEl,p)):secaoOfertasEl&&(secaoOfertasEl.style.display="none");for(const[e,t]of dynamicCategories.entries()){const r=l.filter(t=>t.categoria===e),o=!c.categoria||e===c.categoria;o&&r.length>0?(t.sectionEl&&(t.sectionEl.style.display="block"),t.containerEl&&("priceAsc"===currentSortOrder?r.sort((e,t)=>e.preco-t.preco):"priceDesc"===currentSortOrder&&r.sort((e,t)=>t.preco-e.preco),criarCardsEAdicionar(t.containerEl,r))):t.sectionEl&&(t.sectionEl.style.display="none")}document.getElementById("sortAsc").classList.toggle("active","priceAsc"===currentSortOrder),document.getElementById("sortDesc").classList.toggle("active","priceDesc"===currentSortOrder)}async function loadAndRender(){showSkeletonLoaders(listaOfertasEl,5),vazioElemento(navElement),Array.from(mainElement.querySelectorAll(".secao-categoria")).forEach(e=>e.remove());let e=[];try{const t=await fetchSheetJson(SHEET_ID,GID);e=parseGvizResponse(t),console.log("Dados carregados (gviz):",allProducts.size,"produtos ativos")}catch(t){console.warn("Falha ao carregar via gviz, tentando fallback opensheet:",t);try{const t=`https://opensheet.elk.sh/${SHEET_ID}/Página1`,r=await fetch(t);if(!r.ok)throw new Error(`OpenSheet falhou com status ${r.status}`);const o=await r.json(),a=o.map(e=>{const t=Object.keys(e),r=t.map(t=>({v:e[t]}));return mapRowToProduct(r,t)});e=a.filter(e=>e.ativo),allProducts.clear(),dynamicCategories.clear(),e.forEach(e=>{allProducts.set(e.id,e),dynamicCategories.has(e.categoria)||dynamicCategories.set(e.categoria,{tipos:new Set,generos:new Set,containerId:`lista-${e.categoria}`,sectionId:`secao-${e.categoria}`,sectionEl:null,containerEl:null});const t=dynamicCategories.get(e.categoria);e.tipo&&t.tipos.add(e.tipo),e.genero&&t.generos.add(e.genero)}),console.log("Dados carregados (opensheet):",allProducts.size,"produtos ativos")}catch(e){console.error("Erro ao carregar planilha pelo fallback:",e),mostrarMensagemNoContainer(listaOfertasEl,"Erro ao carregar produtos. Verifique o console."),criarSecoesCategorias();for(const e of dynamicCategories.values())e.containerEl&&mostrarMensagemNoContainer(e.containerEl,"Erro ao carregar produtos.");return}}criarSecoesCategorias();for(const[e,t]of dynamicCategories.entries())t.sectionEl=document.getElementById(t.sectionId),t.containerEl=document.getElementById(t.containerId);popularDropdown(filtroCategoria,dynamicCategories.keys(),"Todas as Categorias"),filtrarEExibirProdutos(),filtroPesquisa.addEventListener("input",filtrarEExibirProdutos),filtroCategoria.addEventListener("change",e=>{const t=e.target.value;if(filtroGenero.value="",filtroGenero.style.display="none",vazioElemento(filtroTipoContainer),filtroTipoContainer.style.display="none",t){const e=dynamicCategories.get(t);e&&(e.generos.size>0&&(popularDropdown(filtroGenero,e.generos,"Todos os Gêneros"),filtroGenero.style.display="block"),e.tipos.size>0&&(criarCheckboxesTipo(filtroTipoContainer,e.tipos),filtroTipoContainer.style.display="flex"))}filtrarEExibirProdutos()}),filtroGenero.addEventListener("change",filtrarEExibirProdutos),precoMin.addEventListener("input",filtrarEExibirProdutos),precoMax.addEventListener("input",filtrarEExibirProdutos),btnSortAsc.addEventListener("click",()=>{currentSortOrder="priceAsc",filtrarEExibirProdutos()}),btnSortDesc.addEventListener("click",()=>{currentSortOrder="priceDesc",filtrarEExibirProdutos()}),btnLimparFiltros.addEventListener("click",()=>{filtroPesquisa.value="",filtroCategoria.value="",filtroGenero.value="",vazioElemento(filtroTipoContainer),precoMin.value="",precoMax.value="",filtroGenero.style.display="none",filtroTipoContainer.style.display="none",currentSortOrder="default",filtrarEExibirProdutos()}),mainElement.addEventListener("click",e=>{adicionarClickHandlerMiniaturas(e),handleAddToCartClick(e),handleCardClick(e)})}const SHEET_ID="1gU34_gLsxTHDy_nxhtg91-Ld6VaU4Zba65dBkZD-2aQ",GID=0;let mainElement,navElement,listaOfertasEl,secaoOfertasEl,filtroPesquisa,filtroCategoria,filtroGenero,filtroTipoContainer,precoMin,precoMax,btnLimparFiltros,btnSortAsc,btnSortDesc,activeTimers={},allProducts=new Map,dynamicCategories=new Map,currentSortOrder="default";document.addEventListener("DOMContentLoaded",()=>{mainElement=document.querySelector("main"),navElement=document.getElementById("menuNavegacao"),listaOfertasEl=document.getElementById("listaOfertas"),secaoOfertasEl=document.getElementById("secao-ofertas"),filtroPesquisa=document.getElementById("filtroPesquisa"),filtroCategoria=document.getElementById("filtroCategoria"),filtroGenero=document.getElementById("filtroGenero"),filtroTipoContainer=document.getElementById("filtroTipoContainer"),precoMin=document.getElementById("precoMin"),precoMax=document.getElementById("precoMax"),btnLimparFiltros=document.getElementById("limparFiltros"),btnSortAsc=document.getElementById("sortAsc"),btnSortDesc=document.getElementById("sortDesc"),loadAndRender().catch(e=>{console.error("Erro na inicialização:",e),mostrarMensagemNoContainer(listaOfertasEl,"Erro grave na inicialização. Verifique o console."),Array.from(mainElement.querySelectorAll(".secao-categoria .container")).forEach(e=>{mostrarMensagemNoContainer(e,"Erro ao carregar produtos.")})}),initCheckout()});